#!/usr/bin/env ruby

INCIDENTS = [
    {actor: 'house', action: 'Jack built'},
    {actor: 'malt', action: 'lay in'},
    {actor: 'rat', action: 'ate'},
    {actor: 'cat', action: 'killed'},
    {actor: 'dog', action: 'worried'},
    {actor: 'cow with the crumpled horn', action: 'tossed'},
    {actor: 'maiden all forlorn', action: 'milked'},
    {actor: 'man all tattered and torn', action: 'kissed'},
    {actor: 'priest all shaven and shorn', action: 'married'},
    {actor: 'rooster that crowed in the morn', action: 'woke'},
    {actor: 'farmer sowing his corn', action: 'kept'},
    {actor: 'horse and the hound and the horn', action: 'belonged to'},
]

class Incident
  attr_accessor :actor, :action
  def initialize(args)
    self.actor = args[:actor]
    self.action = args[:action]
  end
end

require 'forwardable'
class Incidents
  include Enumerable
  extend Forwardable
  def_delegators :collection, :each, :[]
  def initialize(incidents)
    build_incidents(incidents)
  end

  def collection
    @collection ||= []
  end

  private

  def build_incidents(incidents)
    incidents.each {|i| collection << Incident.new(i)}
  end
end

class Verse
  attr_accessor :incidents

  def initialize(incidents)
    self.incidents = incidents
  end

  def to_s
    "#{preamble}#{parts}.#{pause}"
  end

  def preamble
    "This is"
  end

  def pause
    "\n\n"
  end

  def parts
    incidents.inject("") {|ret, i|  "#{VersePart.new(i)}#{ret}"}
  end
end

class VersePart
  attr_accessor :incident
  def initialize(incident)
    self.incident = incident
  end

  def to_s
    " the #{incident.actor} that #{incident.action}"
  end
end

class Verses
  attr_accessor :incidents
  def self.build(incidents)
    self.new(incidents).all
  end

  def initialize(incidents)
    self.incidents = incidents
  end

  def all
    concatenate_verses
  end

  private

  def concatenate_verses(verses = "")
    incidents.count.times {|i| verses << Verse.new(incidents[0..i]).to_s}
    verses
  end
end

class Rhyme
  attr_accessor :incidents
  def initialize(incidents)
    self.incidents = incidents
  end

  def say
    Verses.build(incidents)
  end
end

incidents = Incidents.new(INCIDENTS)
print Rhyme.new(incidents).say
